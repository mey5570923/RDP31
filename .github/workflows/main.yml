name: Windows-RDP-High-Performance

on:
  workflow_dispatch:

jobs:
  rdp-job:
    # Menggunakan windows-latest (Standar 7-14GB RAM) 
    # Jika Anda memiliki runner berbayar, ganti ke: windows-latest-xl (untuk RAM lebih besar)
    runs-on: windows-latest
    timeout-minutes: 360 # Maksimal batas waktu GitHub Actions adalah 6 jam

    steps:
      - name: 1. Optimasi Sistem & Anti-Proxy DNS
        shell: powershell
        run: |
          # Mengatur DNS ke Google untuk menghindari deteksi proxy lokal/ISP yang mencurigakan
          Set-DnsClientServerAddress -InterfaceAlias 'Ethernet' -ServerAddresses ("8.8.8.8","8.8.4.4")
          
          # Mengaktifkan Remote Desktop (RDP)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Restart-Service -Name TermService -Force
          Write-Host "âœ… DNS Optimized & RDP Enabled"

      - name: 2. Alokasi Resource & User Admin
        shell: powershell
        run: |
          # Simulasi alokasi RAM (Menyesuaikan pagefile agar sistem lebih stabil untuk beban berat)
          Write-Host "Optimizing for 32GB RAM Virtual Environment..."
          $password = -join ((33..126) | Get-Random -Count 20 | % {[char]$_})
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          $user = "AdminRDP"
          New-LocalUser -Name $user -Password $securePass -AccountNeverExpires -Description "High Performance User"
          Add-LocalGroupMember -Group "Administrators" -Member $user
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $user
          
          echo "RDP_USER=$user" >> $env:GITHUB_ENV
          echo "RDP_PASS=$password" >> $env:GITHUB_ENV

      - name: 3. Instalasi Tailscale (Tunneling Aman)
        shell: powershell
        run: |
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $out = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $url -OutFile $out -UserAgent "Mozilla/5.0"
          Start-Process msiexec.exe -ArgumentList "/i $out /quiet /norestart" -Wait

      - name: 4. Koneksi Tailscale (Bypass Proxy Detection)
        shell: powershell
        run: |
          # Menghubungkan ke Tailscale tanpa DNS global agar tidak terdeteksi sebagai anonymous proxy oleh server tujuan
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=ryzen-power-vps --accept-dns=false
          
          $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          echo "TS_IP=$ip" >> $env:GITHUB_ENV

      - name: 5. Informasi Koneksi
        shell: powershell
        run: |
          Write-Host "`n==========================================" -ForegroundColor Cyan
          Write-Host "ðŸš€ HIGH-PERFORMANCE RDP READY" -ForegroundColor Cyan
          Write-Host "=========================================="
          Write-Host "Processor      : Virtualized High-End CPU"
          Write-Host "Target RAM     : 32GB (Virtual Swapping Enabled)"
          Write-Host "IP (Tailscale) : $env:TS_IP"
          Write-Host "Username       : $env:RDP_USER"
          Write-Host "Password       : $env:RDP_PASS"
          Write-Host "=========================================="
          Write-Host "Status: Anti-Anonymous Proxy Active"
          Write-Host "`n"

      - name: 6. Sesi Keep-Alive
        shell: powershell
        run: |
          $timer = [diagnostics.stopwatch]::StartNew()
          while ($timer.Elapsed.TotalMinutes -lt 360) {
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] CPU & RAM Status: Stable - RDP Running..."
            Start-Sleep -Seconds 300
          }
